---
title: "Ballot curing"
---

```{r}
#| label: prep

if (requireNamespace("renv", quietly = TRUE)) {
  # This finds the renv project root, even if the .qmd is in a subdirectory
  root <- renv::activate(
    project = rprojroot::find_root(rprojroot::has_file("renv.lock"))
  )
  # Explicitly load the environment
  renv::load(project = root)
}

library(here)
library(dplyr)

i_am('website/index.qmd')

load(here::here('cache/shared_objects.RData'))
```

This list is based on returns through `r today`.

```{r}
vote_forecast <- readr::read_csv(here('data/voter_forecast_2025_hiercal.csv'))

obs_returns |>
  filter(ballot_status == 'Rejected') |>
  select(-election, -county) |>
  mutate(received_date = lubridate::ymd(received_date)) |>
  left_join(select(
    vote_forecast,
    voter_id,
    age = Age,
    support_flag = support_flag_hiercal
  )) |>
  filter(stringr::str_detect(support_flag, 'High')) |>
  arrange(desc(received_date)) |>
  downloadthis::download_this(
    output_name = paste0('rejected_ballots_', today),
    output_extension = '.csv',
    button_label = 'Download list of voters with rejected ballots',
    button_type = 'primary',
    has_icon = TRUE,
    icon = 'fa fa-save',
    csv2 = FALSE
  )
```


```{r}

forecasts <- obs_returns |>
  right_join(select(
    vote_forecast,
    voter_id,
    p_turnout_raw,
    p_support_katie_hiercal,
    support_flag_hiercal
  )) |>
  mutate(
    to_sum = p_turnout_raw * p_support_katie_hiercal,
    p_turnout_today = ifelse(
      !is.na(ballot_status) & ballot_status == 'Accepted',
      1,
      p_turnout_raw
    ),
    to_sum_today = p_turnout_today * p_support_katie_hiercal
  ) |>
  summarise(
    pct_wilson_pred = sum(to_sum) / sum(p_turnout_raw),
    pct_wilson_update = sum(to_sum_today) / sum(p_turnout_today)
  )
```

## Updates to forecasted vote share

The forecasts predict Katie will win `r format(forecasts$pct_wilson_pred * 100, digits = 1, nsmall = 1)`% of the vote. However, if we assume anyone who has had their ballot accepted has a probability of voting of 1, we now predict she will win `r format(forecasts$pct_wilson_update * 100, digits = 1, nsmall = 1)`% of the vote.
